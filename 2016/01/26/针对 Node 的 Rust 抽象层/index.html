<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="shortcut icon" href="/" type="image/x-icon"><link rel="stylesheet" href="/stylesheet/brutalist.css"><title>针对 Node 的 Rust 抽象层 · zypeh's blog</title><meta name="description" content="针对 Node 的 Rust 抽象层 - zypeh's blog"><link rel="search" href="https://zypeh.github.io/atom.xml" type="application/opensearchdescription+xml" title="zypeh's blog"></head><body><div class="container"><script>window.onscroll = function() {scrollFunction()};
function scrollFunction(){if(document.body.scrollTop>320||document.documentElement.scrollTop>320){document.getElementById("gotoTop").className=""}else{document.getElementById("gotoTop").className="hidden"}}
function gotoTop(){document.body.scrollTop = 0;document.documentElement.scrollTop=0}</script><div class="wrapper"><div class="side-nav"><div class="side-nav-inner"><nav><ul><li><a href="/" target="_self">首页</a></li><li><a href="/archives" target="_self">归档</a></li><li><a href="/about" target="_self">关于</a></li></ul></nav><div class="divider-bold"></div></div></div><div class="spacing"><div class="spacing-inner"></div></div><main role="main"><div class="content"><header><div id="title"><h1>针对 Node 的 Rust 抽象层</h1></div><div id="description"><p></p></div><div class="divider-curly"></div></header><article><h1><span id="nodejs-是什么">Nodejs 是什么</span><a href="#nodejs-是什么" class="linea">¶</a></h1>
<p>Node.js 是谷歌 V8 引擎、libuv平台抽象层 以及主体使用 Javscript 编写的核心库三者集合的一个包装外壳。” 除此之外，值得注意的是，Node.js 的作者瑞恩·达尔 (Ryan Dahl) 的目标是创建具有实时推送能力的网站。在 Node.js 中，他给了开发者一个使用事件驱动来实现异步开发的优秀解决方案。</p>
<p>Javscript 在 IO 密集的应用场景例如 RESTful 环境下，Node.js 能发挥高并发，足以应付巨量的请求。但是你绝对不会用它来做 CPU 密集的工作吧？</p>
<p>所以主流的是用 C++, C 来为 Node.js 编写原生模块 (native modules)。但是鉴于现在个人学习新秀语言 Rust ，因此打算说下两者之间如何互相使用。</p>
<h2><span id="谈谈-c-语言和-v8-引擎的关系">谈谈 C++ 语言和 V8 引擎的关系</span><a href="#谈谈-c-语言和-v8-引擎的关系" class="linea">¶</a></h2>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports.hello = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="string">'hello from C++'</span>; &#125;;</div></pre></td></tr></table></figure>
<p>这样的 Javascript 代码用 C++ 利用 V8 标准库下。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// hello.cc</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;node.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> v8;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Method</span><span class="params">(<span class="keyword">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args)</span> </span>&#123;</div><div class="line">  Isolate* isolate = Isolate::GetCurrent();</div><div class="line">  <span class="function">HandleScope <span class="title">scope</span><span class="params">(isolate)</span></span>;</div><div class="line">  args.GetReturnValue().Set(String::NewFromUtf8(isolate, <span class="string">"world"</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(Handle&lt;Object&gt; exports)</span> </span>&#123;</div><div class="line">  NODE_SET_METHOD(exports, <span class="string">"hello"</span>, Method);</div><div class="line">&#125;</div><div class="line"></div><div class="line">NODE_MODULE(addon, init)</div></pre></td></tr></table></figure>
<p>根据源码， <code>method</code> 接受 callbacks 然后在内部进行 Handle 控制，大体就是把 args 的 <code>return value</code> 设成 JS 里的物件类型, 在这里我们设它为 <em>world</em>。</p>
<p><code>NODE_MODULE</code> 就是注册一个 Node Module, addon 就是其文件名。之后会编译成 <em>addon.node</em> (以 <code>.node</code> 做后缀)</p>
<h2><span id="rust-语言简单介绍">Rust 语言简单介绍</span><a href="#rust-语言简单介绍" class="linea">¶</a></h2>
<p>Rust 语言是一门强调安全、并发、高效的系统编程语言。个人认为是个值得期待的系统编程语言之一。因为其对底层内存控制和安全把捏的很好，这里我们会用它来编写我们的 node 模块。因为编写个 Nodejs 模块最主要的原因还是因为 javascript 不能很高效地完成内存和大量运算，安全才是 Rust 语言的卖点。</p>
<h2><span id="neon">Neon</span><a href="#neon" class="linea">¶</a></h2>
<p>Neon 是近期很新颖的一个 Node 抽象层。从语法的角度来说简化了许多，而且还针对 Node.js 的环境，Neon 保证其 JS 堆和 Rust 的栈能完美的被垃圾回收机制跟踪。</p>
<p>考虑效率问题，因为 JS FFI (Foreign Function Interface) 开销也是很大的，尽可能用原生 JS, 万不得已才考虑。</p>
<p>代码为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="number">133.7</span>/PI); &#125;</div></pre></td></tr></table></figure>
<p>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install -g neon-cli</div></pre></td></tr></table></figure>
<p>创建新的项目</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ neon-cli new &lt;project_name&gt;</div></pre></td></tr></table></figure>
<h2><span id="探讨-neon-所搭建的项目">探讨 neon 所搭建的项目</span><a href="#探讨-neon-所搭建的项目" class="linea">¶</a></h2>
<p>其中有 package.json, README.md, 值得记下的有这几个</p>
<table>
<thead>
<tr>
<th style="text-align:center">路径</th>
<th style="text-align:center">内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>./lib</code></td>
<td style="text-align:center">里面含有 JS 代码</td>
</tr>
<tr>
<td style="text-align:center"><code>./native</code></td>
<td style="text-align:center">内含 Rust 语言的包 (包括 Cargo.toml, /src 等等)</td>
</tr>
<tr>
<td style="text-align:center"><code>./node_modules</code></td>
<td style="text-align:center">里面包含所有 node modules, 你的需求都在这</td>
</tr>
</tbody>
</table>
<p>我们看看 <code>lib</code> 的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> addon = <span class="built_in">require</span>(<span class="string">'../native'</span>);</div><div class="line"><span class="built_in">console</span>.log(addon.hello());</div></pre></td></tr></table></figure>
<p>没啥特别的，就简单的从 native 路径加载模块。</p>
<p>我们看看 <code>native</code> 里的源码</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#[macro_use]</span></div><div class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> neon;</div><div class="line"></div><div class="line"><span class="keyword">use</span> neon::vm::&#123;Call, JsResult, Module&#125;;</div><div class="line"><span class="keyword">use</span> neon::js::JsString;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">fn</span> <span class="title">hello</span></span>(call: Call) -&gt; JsResult&lt;JsString&gt; &#123;</div><div class="line">  <span class="keyword">let</span> scope = call.scope;</div><div class="line">  <span class="literal">Ok</span>(JsString::new(scope, <span class="string">"hello node"</span>).unwrap())</div><div class="line">&#125;</div><div class="line"></div><div class="line">register_module!(m, &#123;</div><div class="line">  m.export(<span class="string">"hello"</span>, hello)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这就是简单的打印 hello node 的 nodejs 模块。</p>
<p><code>register_module!</code> 是个宏 (macro)，用来注册 module 用。<code>Call</code> 就是一个 Rust 的物件，封装了 JS 和 Rust 的内存。Neon 函数就会接受 <code>Call</code> 然后返回 <code>JsResult</code> 或是 <code>throw</code> 的异常值。</p>
<h4><span id="参考资料">参考资料</span><a href="#参考资料" class="linea">¶</a></h4>
<ul>
<li><a href="http://wiki.jikexueyuan.com/project/nodejs/addons.html" target="_blank" rel="external">Nodejs</a></li>
<li><a href="https://segmentfault.com/a/1190000000453606" target="_blank" rel="external">Javascript 里有个 C</a></li>
<li><a href="https://github.com/kkaefer/node-cpp-modules" target="_blank" rel="external">node-cpp-modules // github</a> - 这里有许多的 comment 和例子</li>
<li><a href="https://github.com/rustbridge/neon" target="_blank" rel="external">neon // github </a></li>
</ul>
</article></div></main><div class="corner_layer"><div class="corner_button"><button id="gotoTop" onclick="gotoTop()" class="hidden"><svg width="16" height="16" viewBox="0 0 17 17" xmlns="http://www.w3.org/2000/svg"><title>回到顶部</title><g><path d="M12.036 15.59c0 .55-.453.995-.997.995H5.032c-.55 0-.997-.445-.997-.996V8.584H1.03c-1.1 0-1.36-.633-.578-1.416L7.33.29c.39-.39 1.026-.385 1.412 0l6.878 6.88c.782.78.523 1.415-.58 1.415h-3.004v7.004z" fill-rule="evenodd"></path></g></svg></button></div></div></div></div><footer><p>© 2017 - 2018 <a href="https://zypeh.github.io">zypeh</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/zypeh/hexo-theme-brutalist" target="_blank">hexo-theme-brutalist</a>.</p><ul><li> <a href="https://zypeh.github.io">home</a></li><li><a href="/atom.xml">atom</a></li></ul></footer></body></html>